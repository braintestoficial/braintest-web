<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hist√≥rico ‚Äî Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<script src="/assets/app.js" defer></script>
</head>
<body>
<div class="shell">

  <header class="topbar">
    <a class="brand" href="/index.html"><img src="/assets/logo.svg" alt=""><span>Braintest</span></a>
    <div class="search" style="flex:1;margin-left:8px"><input placeholder="Busque‚Ä¶"></div>
    <div class="user-chip" id="userChip">Carregando‚Ä¶</div>
    <a class="btn alt" href="/carteira.html">Saldo: <span id="saldoTop">0.00</span> BC</a>
  </header>

  <div class="body">
    <aside class="sidebar">
      <nav class="nav">
        <h6>Navega√ß√£o</h6>
        <a href="/index.html" data-current>üè† In√≠cio</a>
        <a href="/historico.html" class="active" data-current>üïò Hist√≥rico</a>
        <a href="/carteira.html" data-current>üí≥ Carteira</a>
        <a href="/perfil.html" data-current>üë§ Perfil</a>
        <h6 style="margin-top:14px">Testes</h6>
        <a href="/teste-tdah.html" data-current>‚ö° TDAH</a>
        <a href="/teste-burnout.html" data-current>üî• Burnout</a>
        <a href="/teste-qi.html" data-current>üß† QI</a>
      </nav>
    </aside>

    <main class="content">
      <div class="container">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
            <h2 style="margin:0;font-family:Poppins,Inter">Hist√≥rico de triagens</h2>
            <div class="controls">
              <select id="fTeste">
                <option value="">Todos os testes</option>
                <option value="tdah">TDAH</option>
                <option value="burnout">Burnout</option>
                <option value="qi">QI</option>
              </select>
              <input type="date" id="fDe">
              <input type="date" id="fAte">
              <button class="btn small" id="btnFiltrar">Filtrar</button>
              <button class="btn alt small" id="btnLimpar">Limpar</button>
            </div>
          </div>

          <div id="status" class="small" style="margin:.4rem 0 0"></div>

          <table class="table" id="grid" style="margin-top:.6rem">
            <thead>
              <tr>
                <th>Data</th>
                <th>Teste</th>
                <th>Itens</th>
                <th>Resultado</th>
                <th style="width:240px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="5" class="small">Carregando‚Ä¶</td></tr></tbody>
          </table>

          <div class="pager" style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem">
            <button id="prevBtn" disabled>‚óÄ Anteriores</button>
            <button id="nextBtn" disabled>Pr√≥ximas ‚ñ∂</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <nav class="mobilebar">
    <a href="/index.html" data-current>üè†</a>
    <a href="/teste-tdah.html" data-current>‚ö°</a>
    <a href="/teste-burnout.html" data-current>üî•</a>
    <a href="/teste-qi.html" data-current>üß†</a>
    <a href="/perfil.html" data-current>üë§</a>
  </nav>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:.2rem 0">Detalhes da sess√£o</h3>
      <button class="btn alt small" id="closeModal">Fechar</button>
    </div>
    <div id="detalhes" class="kv" style="margin-top:.5rem"></div>
    <div id="respostas"></div>
  </div>
</div>

<script>
const PAGE_SIZE=10; let userId=null; let page=0; let lastPage=false;
const premiumURL = (t)=>({tdah:'/tdah-premium.html',burnout:'/burnout-premium.html',qi:'/qi-premium.html'}[t]||'#');
function fmt(iso){ if(!iso) return '-'; const d=new Date(iso); return d.toLocaleString('pt-BR',{dateStyle:'short', timeStyle:'short'}); }
function setStatus(msg){ document.getElementById('status').innerHTML = msg||''; }
function lineResultado(r){ if(r.test==='qi'){ return `QI: <b>${r.score_qi??0}</b> / ${r.items_qty}` } const max=(r.items_qty||0)*2; return `Likert: <b>${r.score_likert??0}</b> / ${max}`; }

async function loadSaldo(uid){ const {data:w}=await sb.from('wallets').select('balance_cents').eq('user_id',uid).single(); return (w?.balance_cents||0)/100; }
async function loadCompras(uid){ const {data:rows}=await sb.from('purchases').select('product').eq('user_id',uid); return new Set((rows||[]).map(r=>r.product)); }

async function fetchPage(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML=`<tr><td colspan="5" class="small">Carregando‚Ä¶</td></tr>`;
  setStatus('Carregando hist√≥rico‚Ä¶');

  const fTeste=document.getElementById('fTeste').value||null;
  const fDe=document.getElementById('fDe').value||null;
  const fAte=document.getElementById('fAte').value||null;

  let q=sb.from('test_sessions').select('id,created_at,test,items_qty,score_likert,score_qi').eq('user_id',userId);
  if(fTeste) q=q.eq('test',fTeste);
  if(fDe) q=q.gte('created_at', new Date(fDe+'T00:00:00').toISOString());
  if(fAte) q=q.lte('created_at', new Date(fAte+'T23:59:59').toISOString());
  q=q.order('created_at',{ascending:false}).range(page*PAGE_SIZE, page*PAGE_SIZE+PAGE_SIZE-1);

  const { data:rows, error } = await q;
  if(error){ setStatus(`<span style="color:#b00020">Erro: ${error.message}</span>`); return; }
  const compras = await loadCompras(userId);

  tbody.innerHTML='';
  if(!rows||!rows.length){ tbody.innerHTML=`<tr><td colspan="5" class="small">Nenhuma sess√£o encontrada.</td></tr>`; setStatus(''); document.getElementById('prevBtn').disabled=(page===0); document.getElementById('nextBtn').disabled=true; return; }

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${fmt(r.created_at)}</td>
      <td>${r.test.toUpperCase()}</td>
      <td>${r.items_qty||0}</td>
      <td>${lineResultado(r)}</td>
      <td>
        <button class="btn alt small" data-act="ver" data-id="${r.id}" data-test="${r.test}">Ver respostas</button>
        ${compras.has(r.test) ? 
          `<a class="btn small" data-act="open" href="${premiumURL(r.test)}">Abrir relat√≥rio</a>` :
          `<button class="btn small" data-act="comprar" data-test="${r.test}">Desbloquear (10 BC)</button>`}
      </td>`;
    tbody.appendChild(tr);
  });
  lastPage = rows.length<PAGE_SIZE;
  document.getElementById('prevBtn').disabled=(page===0);
  document.getElementById('nextBtn').disabled=lastPage;
  setStatus('');
}

async function openModalDetalhes(sessionId){
  const modal=document.getElementById('modal'); modal.style.display='flex';
  const detalhes=document.getElementById('detalhes'); const respostas=document.getElementById('respostas');
  detalhes.innerHTML='Carregando‚Ä¶'; respostas.innerHTML='';
  const {data:s}=await sb.from('test_sessions').select('*').eq('id',sessionId).single();
  const {data:aRows}=await sb.from('test_answers').select('question_id, option_id, value, is_correct').eq('session_id',sessionId).order('question_id');
  const qids=(aRows||[]).map(a=>a.question_id); const oids=(aRows||[]).map(a=>a.option_id);
  const {data:qRows}=await sb.from('test_questions').select('id,prompt').in('id',qids);
  const {data:oRows}=await sb.from('test_question_options').select('id,label').in('id',oids);
  const mapQ=new Map((qRows||[]).map(q=>[q.id,q.prompt])); const mapO=new Map((oRows||[]).map(o=>[o.id,o.label]));
  detalhes.innerHTML=`<div>Data</div><div>${fmt(s.created_at)}</div><div>Teste</div><div>${s.test.toUpperCase()}</div><div>Itens</div><div>${s.items_qty||0}</div><div>Resultado</div><div>${s.test==='qi'?(s.score_qi||0)+' / '+(s.items_qty||0):(s.score_likert||0)+' / '+((s.items_qty||0)*2)}</div>`;
  (aRows||[]).forEach(a=>{
    const dv=document.createElement('div'); dv.className='resposta';
    dv.innerHTML=`<div class="small" style="color:var(--muted)">${a.question_id}</div><div style="font-weight:800;margin:.2rem 0">${mapQ.get(a.question_id)||'Pergunta'}</div><div>Resposta: <b>${mapO.get(a.option_id)||(a.value ?? '-')}</b> ${a.is_correct?'<span class="badge" style="margin-left:.25rem;background:#f2fff5;border-color:#cdebd4;color:#184d2b">Correta</span>':''}</div>`;
    respostas.appendChild(dv);
  });
}

async function handleClick(e){
  const btn=e.target.closest('[data-act]'); if(!btn) return;
  const act=btn.dataset.act; const test=btn.dataset.test;
  if(act==='ver'){ openModalDetalhes(btn.dataset.id); }
  if(act==='comprar'){
    const PRICE_CENTS=1000; const {data:{user}}=await sb.auth.getUser();
    const {data:w}=await sb.from('wallets').select('balance_cents').eq('user_id',user.id).single();
    const bal=w?.balance_cents||0; if(bal<PRICE_CENTS){ if(confirm('Saldo insuficiente. Adicionar Braincoins agora?')) location.href='/carteira.html'; return; }
    const {error}=await sb.rpc('wallet_buy',{ p_product:test, p_price_cents:PRICE_CENTS, p_description:`Relat√≥rio premium: ${test.toUpperCase()}` });
    if(error){ alert('N√£o foi poss√≠vel concluir a compra.'); return; }
    alert('Relat√≥rio desbloqueado!'); fetchPage();
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await waitForSupabaseSession();
  const {data:{user}}=await sb.auth.getUser();
  if(!user){ location.href='/perfil.html'; return; }
  document.getElementById('userChip').textContent=user.email||'Usu√°rio';
  const {data:w}=await sb.from('wallets').select('balance_cents').eq('user_id', user.id).single();
  setTopUser(user.email||'Usu√°rio', ((w?.balance_cents||0)/100));
  userId=user.id; fetchPage();
});

document.getElementById('tbody').addEventListener('click', handleClick);
document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') e.currentTarget.style.display='none'; });
document.getElementById('btnFiltrar').addEventListener('click', ()=>{ page=0; fetchPage(); });
document.getElementById('btnLimpar').addEventListener('click', ()=>{ document.getElementById('fTeste').value=''; document.getElementById('fDe').value=''; document.getElementById('fAte').value=''; page=0; fetchPage(); });
document.getElementById('prevBtn').addEventListener('click', ()=>{ if(page>0){ page--; fetchPage(); }});
document.getElementById('nextBtn').addEventListener('click', ()=>{ if(!lastPage){ page++; fetchPage(); }});
</script>
</body>
</html>
