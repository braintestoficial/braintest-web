<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>QI ‚Äî Relat√≥rio Premium | Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<script src="/assets/app.js" defer></script>
<script src="/assets/print.js" defer></script>
<style>
.kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.kpi .card{padding:12px}
.sparks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.spark{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.spark h4{margin:0 0 6px;font-size:14px;color:#334}
svg.sparkline{width:100%;height:48px;display:block}
@media(max-width:920px){.sparks{grid-template-columns:1fr}}
@media(max-width:720px){.kpi{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <a class="brand" href="/index.html"><img src="/assets/logo.svg" alt=""><span>Braintest</span></a>
    <div class="search"><input placeholder="Busque‚Ä¶"></div>
    <div class="top-actions">
      <div class="user-chip" id="userChip">Carregando‚Ä¶</div>
      <a class="btn alt" href="/carteira.html">Saldo: <span id="saldoTop">0.00</span> BC</a>
    </div>
  </header>

  <div class="body">
    <aside class="sidebar">
      <nav class="nav">
        <h6>Relat√≥rios</h6>
        <a href="/tdah-premium.html" data-current>‚ö° TDAH</a>
        <a href="/burnout-premium.html" data-current>üî• Burnout</a>
        <a href="/qi-premium.html" class="active" data-current>üß† QI</a>
        <h6 style="margin-top:14px">Navega√ß√£o</h6>
        <a href="/index.html" data-current>üè† In√≠cio</a>
        <a href="/historico.html" data-current>üïò Hist√≥rico</a>
        <a href="/carteira.html" data-current>üí≥ Carteira</a>
        <a href="/perfil.html" data-current>üë§ Perfil</a>
      </nav>
    </aside>

    <main class="content">
      <div class="container">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
            <h2 style="margin:0;font-family:Poppins,Inter">Relat√≥rio Premium ‚Äî QI (estimativa)</h2>
            <button class="btn alt small" onclick="exportPDF('Relatorio-Premium-QI','#content')">Exportar PDF</button>
          </div>

          <div id="gate" class="small" style="margin:8px 0 12px"></div>

          <div id="content" style="display:none">
            <p class="small">Baseado nas suas sess√µes recentes (at√© 8). Estimativa educacional; n√£o √© teste psicom√©trico padronizado.</p>

            <div class="card" style="margin-top:8px">
              <h3 style="margin:0 0 6px">Resumo executivo</h3>
              <div id="resumo"></div>
            </div>

            <div class="kpi" style="margin-top:12px">
              <div class="card">
                <div class="title small">Num√©rico</div>
                <div class="value" id="v_num" style="font-size:24px;font-weight:800">‚Äî</div>
                <div class="small">Aritm√©tica e sequ√™ncias.</div>
              </div>
              <div class="card">
                <div class="title small">L√≥gico</div>
                <div class="value" id="v_log" style="font-size:24px;font-weight:800">‚Äî</div>
                <div class="small">Analogia e dedu√ß√£o.</div>
              </div>
              <div class="card">
                <div class="title small">Espacial (simplif.)</div>
                <div class="value" id="v_esp" style="font-size:24px;font-weight:800">‚Äî</div>
                <div class="small">Padr√µes e rela√ß√µes visuais.</div>
              </div>
            </div>

            <div class="grid cols-2" style="margin-top:12px">
              <div class="card">
                <h3 style="margin:0 0 6px">Interpreta√ß√£o personalizada</h3>
                <div id="interp"></div>
              </div>
              <div class="card">
                <h3 style="margin:0 0 6px">Como evoluir</h3>
                <ul class="small" id="evoluir" style="margin:0 0 0 18px;line-height:1.7"></ul>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0 0 6px">Evolu√ß√£o recente</h3>
              <div class="sparks" id="evolucao"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0 0 6px">Pr√≥ximos passos</h3>
              <ul class="small" id="next" style="margin:0 0 0 18px;line-height:1.7"></ul>
            </div>

            <p class="small" style="margin-top:12px;color:#5b6478">Aviso: n√£o substitui avalia√ß√£o psicom√©trica conduzida por profissional.</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <nav class="mobilebar">
    <a href="/index.html" data-current>üè†</a>
    <a href="/teste-tdah.html" data-current>‚ö°</a>
    <a href="/teste-burnout.html" data-current>üî•</a>
    <a href="/teste-qi.html" data-current>üß†</a>
    <a href="/perfil.html" data-current>üë§</a>
  </nav>
</div>

<script>
const PRODUCT='qi';
function pctFmt(v){ return isFinite(v)? Math.round(v)+'%' : '‚Äî'; }
function estIQ(p){ const z = (p - 50) / 24; return Math.round(100 + z*15); }
function pctToPercentil(p){ if(p<=5) return '‚â§ 5¬∫'; if(p<=16) return '16¬∫'; if(p<=25) return '25¬∫'; if(p<=50) return '50¬∫'; if(p<=75) return '75¬∫'; if(p<=84) return '84¬∫'; if(p<=95) return '95¬∫'; return '‚â• 97¬∫'; }
function sparkline(points){
  if(!points || !points.length) return '';
  const w=200,h=48,pad=2; const n=points.length; const step=(w-2*pad)/Math.max(1,n-1);
  const ys=points.map(p=>{ const y=h-pad-(p/100)*(h-2*pad); return Math.max(pad,Math.min(h-pad,y)); });
  const xs=Array.from({length:n},(_,i)=>pad+i*step);
  const last=points[n-1]; const color= last>=66?'#ff7458': last>=33?'#f5b500':'#1d3557';
  return `<svg class="sparkline" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <rect x="0" y="0" width="${w}" height="${h}" fill="white" rx="8" ry="8"></rect>
    <polyline fill="none" stroke="${color}" stroke-width="2" points="${xs.map((x,i)=>`${x},${ys[i]}`).join(' ')}"/>
  </svg>`;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const user = await requireAuth('/qi-premium.html'); if(!user) return;
  await ensureTopbarUser();

  // Gate
  const g=document.getElementById('gate'); const c=document.getElementById('content');
  const {data:have}=await sb.from('purchases').select('product').eq('user_id',user.id).eq('product',PRODUCT).maybeSingle();
  if(!have){ g.innerHTML=`<div style="padding:.8rem;border:1px dashed var(--line);border-radius:12px;background:#fff">
    Relat√≥rio bloqueado. <a class="btn small" href="/teste-qi.html" style="margin-left:6px">Desbloquear (10 BC)</a></div>`; return; }
  g.innerHTML=`<span class="badge" style="background:#f2fff5;border-color:#cdebd4;color:#184d2b">Acesso liberado</span>`;
  c.style.display='block';

  // At√© 8 sess√µes
  const { data:sessions } = await sb.from('test_sessions').select('id,created_at,items_qty,score_qi').eq('user_id',user.id).eq('test','qi').order('created_at',{ascending:false}).limit(8);

  let tot=0, items=0;
  let dom={ numerico:{ok:0,tot:0}, logico:{ok:0,tot:0}, espacial:{ok:0,tot:0} };
  const sGlobal=[], sNum=[], sLog=[], sEsp=[];

  for(const s of (sessions||[]).reverse()){
    tot += s.score_qi||0; items += s.items_qty||0;
    const { data:ans } = await sb.from('test_answers').select('question_id,is_correct').eq('session_id', s.id);
    const qids=(ans||[]).map(a=>a.question_id);
    const { data:qs } = await sb.from('test_questions').select('id,domain').in('id', qids);
    const map = new Map((qs||[]).map(q=>[q.id, q.domain||'']));
    let sess={ numerico:{ok:0,tot:0}, logico:{ok:0,tot:0}, espacial:{ok:0,tot:0} };
    (ans||[]).forEach(a=>{
      const d=map.get(a.question_id); if(!d) return;
      sess[d].tot++; if(a.is_correct) sess[d].ok++;
      dom[d].tot++; if(a.is_correct) dom[d].ok++;
    });
    const pNum = sess.numerico.tot? (sess.numerico.ok/sess.numerico.tot)*100 : 0;
    const pLog = sess.logico.tot?   (sess.logico.ok/sess.logico.tot)*100   : 0;
    const pEsp = sess.espacial.tot? (sess.espacial.ok/sess.espacial.tot)*100 : 0;
    const pGl  = (pNum+pLog+pEsp)/3;
    sNum.push(pNum); sLog.push(pLog); sEsp.push(pEsp); sGlobal.push(pGl);
  }

  const pGlobal = items? (tot/items)*100 : 0;
  const iq = estIQ(pGlobal);
  const percentil = pctToPercentil(Math.round(pGlobal));

  document.getElementById('resumo').innerHTML =
    `<div class="grid cols-3">
      <div><b>Estimativa de QI:</b> ${iq}</div>
      <div><b>Acerto global:</b> ${pctFmt(pGlobal)} (${percentil} percentil aprox.)</div>
      <div><b>Base amostral:</b> ${items} itens nas √∫ltimas sess√µes</div>
    </div>`;

  const pNum = dom.numerico.tot? (dom.numerico.ok/dom.numerico.tot)*100 : 0;
  const pLog = dom.logico.tot?   (dom.logico.ok/dom.logico.tot)*100   : 0;
  const pEsp = dom.espacial.tot? (dom.espacial.ok/dom.espacial.tot)*100 : 0;
  document.getElementById('v_num').textContent = pctFmt(pNum);
  document.getElementById('v_log').textContent = pctFmt(pLog);
  document.getElementById('v_esp').textContent = pctFmt(pEsp);

  const fortes = [ ['Num√©rico',pNum], ['L√≥gico',pLog], ['Espacial',pEsp] ].sort((a,b)=>b[1]-a[1]);
  const fr=[
    `<li><b>Ponto forte:</b> ${fortes[0][0]} (${pctFmt(fortes[0][1])}). Potencialize com desafios semanais nesse dom√≠nio.</li>`,
    `<li><b>Oportunidade:</b> ${fortes[2][0]} (${pctFmt(fortes[2][1])}). Pratique 10‚Äì15 min/dia com problemas progressivos.</li>`,
    iq>=115 ? '<li><b>Perfil:</b> acima da m√©dia; busque itens de dificuldade crescente.</li>' :
    iq>=100 ? '<li><b>Perfil:</b> na m√©dia; consist√™ncia e estrat√©gia aumentam o teto.</li>' :
              '<li><b>Perfil:</b> em evolu√ß√£o; foco em fundamentos e revis√£o espa√ßada.</li>'
  ];
  document.getElementById('interp').innerHTML = `<ul class="small" style="margin:0 0 0 18px;line-height:1.7">${fr.join('')}</ul>`;

  const evo=[
    'Num√©rico: pratique sequ√™ncias, propor√ß√µes e opera√ß√µes cronometradas (2‚Äì3 s√©ries curtas).',
    'L√≥gico: resolva analogias e silogismos explicando sua linha de racioc√≠nio.',
    'Espacial: exerc√≠cios de padr√µes e rota√ß√µes mentais (comece com 2D).',
    'Metacogni√ß√£o: ap√≥s cada quest√£o, anote por que acertou/errou.'
  ];
  document.getElementById('evoluir').innerHTML = evo.map(x=>`<li>${x}</li>`).join('');

  const next=[
    'Psicol√≥gicos: teste TDAH e Burnout para entender fatores n√£o cognitivos.',
    'Assinatura (em breve): baterias maiores, hist√≥rico e benchmarks.',
    'Jogos cognitivos (em breve): Sudoku, s√©ries l√≥gicas e mem√≥ria de trabalho.'
  ];
  document.getElementById('next').innerHTML = next.map(x=>`<li>${x}</li>`).join('');

  // Evolu√ß√£o (sparks)
  const evoWrap=document.getElementById('evolucao');
  [
    ['Acerto global', sGlobal],
    ['Num√©rico', sNum],
    ['L√≥gico', sLog],
    ['Espacial', sEsp]
  ].forEach(([title, serie])=>{
    const div=document.createElement('div'); div.className='spark';
    div.innerHTML = `<h4>${title}</h4>${sparkline(serie)}`;
    evoWrap.appendChild(div);
  });
});
</script>
</body>
</html>
