<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Teste de Q.I. | Braintest</title>
<link rel="stylesheet" href="/assets/ui.css" />
<link rel="stylesheet" href="/assets/ui-dashboard.css" />
<script async src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1.5rem;margin-bottom:1rem}
  .question{margin:.8rem 0}
  .question p{margin-bottom:.4rem}
  .options label{display:block;margin:.3rem 0}
  #resultado{margin-top:1.5rem;padding:1rem;background:#f9fafb;border-radius:8px}
  #premiumBtn{margin-top:1rem}
</style>
</head>
<body>
<header class="topbar">
  <a class="brand" href="/index.html"><img src="/assets/logo.svg" height="28"> Braintest</a>
  <div class="user-info">
    <span id="userEmail" style="cursor:pointer"></span> â€”
    ðŸ’° <span id="saldoTop" style="cursor:pointer"></span>
  </div>
</header>

<main class="content" style="max-width:700px;margin:auto;padding:2rem;">
  <div class="card">
    <h2>Triagem â€” Q.I.</h2>
    <p>Responda 15 perguntas para estimar seu quociente de inteligÃªncia.</p>
    <div id="status" style="margin:.6rem 0;color:#6b7280">Carregando perguntasâ€¦</div>
    <form id="quiz"></form>
    <button class="btn" id="enviar" style="margin-top:1rem">Enviar respostas</button>
  </div>

  <div id="resultado" style="display:none"></div>
</main>

<script src="/assets/supabase-init.js"></script>
<script>
window.addEventListener("braintest-ready", async()=>{
  const {data:{session}} = await sb.auth.getSession();
  if(!session){location.href="/";return;}
  const {data:{user}} = await sb.auth.getUser();
  const {data:wallet} = await sb.from("wallets").select("balance").eq("user_id",user.id).single();
  const saldo = wallet?.balance ?? 0;
  document.getElementById("userEmail").textContent = user.email.split("@")[0];
  document.getElementById("userEmail").onclick = ()=>location.href="/perfil.html";
  const saldoEl = document.getElementById("saldoTop");
  saldoEl.textContent = `${saldo} ðŸ§ `;
  saldoEl.onclick = ()=>location.href="/carteira.html";

  const TEST="qi";
  const status=document.getElementById("status");
  let perguntas=[];

  try{
    const {data}=await sb.rpc("get_random_questions",{p_test_key:TEST,p_limit:15});
    if(data?.length) perguntas=data;
  }catch(e){console.warn("Erro RPC",e);}

  if(!perguntas.length){
    const {data}=await sb.from("test_questions")
      .select("id,prompt").eq("test_key",TEST).order("random()").limit(15);
    perguntas=data||[];
  }
  if(!perguntas.length){status.textContent="Erro ao carregar perguntas.";return;}

  const {data:opts}=await sb.from("test_question_options")
    .select("question_id,label,is_correct").in("question_id",perguntas.map(q=>q.id));
  const byQ={};(opts||[]).forEach(o=>{(byQ[o.question_id] ||= []).push(o);});
  perguntas=perguntas.map(q=>({...q,options:byQ[q.id]||[]}));

  const quiz=document.getElementById("quiz");
  quiz.innerHTML=perguntas.map((q,i)=>`
    <div class="question fade-in">
      <p><b>${i+1}.</b> ${q.prompt}</p>
      <div class="options">
      ${(q.options||[]).map(o=>`
        <label><input type="radio" name="q${q.id}" value="${o.is_correct ? 1 : 0}"> ${o.label}</label>`).join("")}
      </div>
    </div>`).join("");
  status.textContent=`${perguntas.length} perguntas carregadas.`;

  document.getElementById("enviar").onclick=async(ev)=>{
    ev.preventDefault();
    const respostas=perguntas.map(q=>{
      const v=document.querySelector(`input[name="q${q.id}"]:checked`);
      return Number(v?.value||0);
    });
    const corretas=respostas.filter(v=>v===1).length;
    const score=Math.round((corretas/perguntas.length)*120);
    await sb.from("test_sessions").insert({user_id:user.id,test_key:TEST,items_qty:respostas.length,score_qi:score});

    const resBox=document.getElementById("resultado");
    resBox.style.display="block";
    resBox.innerHTML=`
      <h3>Seu Q.I. estimado: ${score}</h3>
      <p>${
        score < 80 ? "Resultado abaixo da mÃ©dia â€” seu desempenho pode ter sido afetado por distraÃ§Ãµes ou cansaÃ§o."
      : score < 110 ? "Na mÃ©dia â€” bom equilÃ­brio entre raciocÃ­nio lÃ³gico e atenÃ§Ã£o."
      : score < 130 ? "Acima da mÃ©dia â€” excelente capacidade analÃ­tica e foco."
      : "Muito acima da mÃ©dia â€” raciocÃ­nio excepcional e alta velocidade cognitiva."
      }</p>
      <button class="btn" id="premiumBtn">Liberar RelatÃ³rio Premium (10 ðŸ§ )</button>
    `;

    document.getElementById("premiumBtn").onclick=async()=>{
      const preco=10;
      if(saldo<preco){alert("Saldo insuficiente! VÃ¡ Ã  Carteira para adicionar Braincoins.");return;}
      const {error:errWallet}=await sb.rpc("wallet_buy",{p_user:user.id,p_amount:preco,p_desc:"RelatÃ³rio Premium: QI"});
      if(errWallet){console.error(errWallet);alert("Erro ao debitar.");return;}
      location.href="/qi-premium.html";
    };
  };
});
</script>
</body>
</html>
