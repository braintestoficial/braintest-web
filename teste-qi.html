<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>QI ‚Äî Triagem | Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<script src="/assets/app.js" defer></script>
</head>
<body>
<div class="shell">

  <header class="topbar">
    <a class="brand" href="/index.html"><img src="/assets/logo.svg" alt=""><span>Braintest</span></a>
    <div class="search" style="flex:1;margin-left:8px"><input placeholder="Busque testes‚Ä¶"></div>
    <div class="user-chip" id="userChip">Carregando‚Ä¶</div>
    <a class="btn alt" href="/carteira.html">Saldo: <span id="saldoTop">0.00</span> BC</a>
  </header>

  <div class="body">
    <aside class="sidebar">
      <nav class="nav">
        <h6>Navega√ß√£o</h6>
        <a href="/index.html" data-current>üè† In√≠cio</a>
        <a href="/historico.html" data-current>üïò Hist√≥rico</a>
        <a href="/carteira.html" data-current>üí≥ Carteira</a>
        <a href="/perfil.html" data-current>üë§ Perfil</a>
        <h6 style="margin-top:14px">Testes</h6>
        <a href="/teste-tdah.html" data-current>‚ö° TDAH</a>
        <a href="/teste-burnout.html" data-current>üî• Burnout</a>
        <a href="/teste-qi.html" class="active" data-current>üß† QI <span class="badge">10 BC</span></a>
      </nav>
    </aside>

    <main class="content">
      <div class="container">
        <div class="card">
          <h2 style="margin:0 0 8px;font-family:Poppins,Inter">QI ‚Äî Triagem Aleat√≥ria (15 itens)</h2>
          <p class="small">Estimativa indicativa. Premium traz an√°lise por dom√≠nio e percentil.</p>
          <div class="hr"></div>
          <div id="statusBox" class="small" style="margin:.6rem 0"></div>
          <form id="formQi"></form>
          <div id="resumo" class="card" style="display:none;margin-top:1rem"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
            <h3 style="margin:0">Relat√≥rio premium</h3>
            <span id="ownedBadge" class="badge" style="display:none;background:#f2fff5;border-color:#cdebd4;color:#184d2b">Desbloqueado</span>
          </div>
          <p class="small" id="premiumDesc" style="margin-top:.25rem">
            Estimativa de QI e percentil. Custo: <strong>10 Braincoins</strong>. Saldo: <strong id="saldoAqui">‚Äî</strong>
          </p>
          <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" id="btnBuy">Desbloquear relat√≥rio (10 BC)</button>
            <a class="btn alt" id="btnAdd" href="/carteira.html">Adicionar Braincoins</a>
            <a class="btn" id="btnOpen" href="/qi-premium.html" style="display:none">Abrir relat√≥rio</a>
          </div>
        </div>
      </div>
    </main>
  </div>

  <nav class="mobilebar">
    <a href="/index.html" data-current>üè†</a>
    <a href="/teste-tdah.html" data-current>‚ö°</a>
    <a href="/teste-burnout.html" data-current>üî•</a>
    <a href="/teste-qi.html" data-current class="active">üß†</a>
    <a href="/perfil.html" data-current>üë§</a>
  </nav>
</div>

<script>
const PRODUCT='qi', PRICE_CENTS=1000, PREMIUM_URL='/qi-premium.html';

function setStatus(msg,type='info'){
  const el=document.getElementById('statusBox'); if(!el) return;
  el.innerHTML = msg ? `<div style="padding:.7rem;border:1px solid ${type==='error'?'#f5b5ab':'#e9ecf2'};background:${type==='error'?'#fff7f5':'#f9fbff'};border-radius:12px">${msg}</div>` : '';
}
function renderForm(questions){
  const f=document.getElementById('formQi'); f.innerHTML='';
  questions.forEach((q,idx)=>{
    const b=document.createElement('div'); b.style.margin='.8rem 0';
    b.innerHTML = `<label style="font-weight:800;display:block;margin-bottom:.35rem">${idx+1}. ${q.prompt}</label>`;
    (q.options||[]).forEach(opt=>{
      const d=document.createElement('div'); d.style.margin='.25rem 0';
      d.innerHTML = `<label><input type="radio" name="q_${q.question_id}" required data-correct="${opt.is_correct ? '1':'0'}"> ${opt.label}</label>`;
      b.appendChild(d);
    });
    f.appendChild(b);
  });
  if(!f.querySelector('button[type=submit]')){
    const btn=document.createElement('button'); btn.type='submit'; btn.className='btn'; btn.textContent='Ver resultado gratuito'; btn.style.marginTop='.8rem'; f.appendChild(btn);
  }
  f.onsubmit=(e)=>{
    e.preventDefault();
    let score=0,cnt=0;
    questions.forEach(q=>{
      const sel=f.querySelector(`input[name="q_${q.question_id}"]:checked`);
      if(sel){ if(sel.dataset.correct==='1') score++; cnt++; }
    });
    const box=document.getElementById('resumo');
    box.style.display='block';
    box.innerHTML=`<b>Resultado gratuito</b><br>Corretas: <b>${score}/${cnt}</b> (estimativa ilustrativa).<br><span class="small">Para an√°lise por dom√≠nio e percentil, desbloqueie o premium.</span>`;
  };
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await waitForSupabaseSession();
  const { data:{ user } } = await sb.auth.getUser();

  if(user){
    const { data:w } = await sb.from('wallets').select('balance_cents').eq('user_id', user.id).single();
    const bc=((w?.balance_cents||0)/100); setTopUser(user.email||'Usu√°rio', bc);
    document.getElementById('saldoAqui').textContent=`${bc.toFixed(2)} BC`;

    const { data:have } = await sb.from('purchases').select('product').eq('user_id', user.id).eq('product', PRODUCT).maybeSingle();
    if(have){
      document.getElementById('btnBuy').style.display='none';
      document.getElementById('btnAdd').style.display='none';
      document.getElementById('btnOpen').style.display='inline-block';
      document.getElementById('premiumDesc').textContent='Voc√™ j√° desbloqueou este relat√≥rio.';
      document.getElementById('ownedBadge').style.display='inline-block';
    }
  }else{
    setStatus('Voc√™ precisa entrar para realizar esta triagem. <a href="/perfil.html">Entrar com Google</a>', 'error');
    document.getElementById('formQi').innerHTML='<p class="small">Sem perguntas para exibir.</p>';
    return;
  }

  setStatus('Carregando perguntas‚Ä¶');
  const { data, error } = await sb.rpc('get_random_questions',{ p_test:'qi', p_qty:15 });
  if(error){ setStatus('Erro ao carregar: <code>'+error.message+'</code>','error'); return; }
  if(!data||!data.length){ setStatus('N√£o encontramos perguntas ativas para este teste.','error'); return; }
  setStatus(''); renderForm(data);
});

document.addEventListener('click', async (e)=>{
  if(e.target && e.target.id==='btnBuy'){
    e.preventDefault();
    const { data:{ user } } = await sb.auth.getUser(); if(!user){ location.href='/perfil.html'; return; }
    const { data:w } = await sb.from('wallets').select('balance_cents').eq('user_id', user.id).single();
    const bal=w?.balance_cents||0; if(bal<PRICE_CENTS){ if(confirm('Saldo insuficiente. Adicionar Braincoins agora?')) location.href='/carteira.html'; return; }
    const { error } = await sb.rpc('wallet_buy',{ p_product:PRODUCT, p_price_cents:PRICE_CENTS, p_description:'Relat√≥rio premium: QI' });
    if(error){ alert('N√£o foi poss√≠vel concluir a compra.'); return; }
    location.href = PREMIUM_URL + '?ok=1';
  }
});
</script>
</body>
</html>
