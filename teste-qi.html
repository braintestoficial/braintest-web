<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teste de Q.I. | Braintest</title>
<link rel="stylesheet" href="/assets/ui.css">
<script async src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="topbar">
  <a class="brand" href="/index.html"><img src="/assets/logo.svg" height="28"> Braintest</a>
  <div class="search"><input placeholder="Buscarâ€¦" id="searchBox"></div>
  <div class="userbox"><b id="userChip"></b> â€” ðŸ’° <b id="saldoTop">0</b> BC</div>
</header>

<main class="content">
  <div class="card">
    <h2>Triagem â€” Q.I.</h2>
    <p>Responda 15 perguntas para obter uma estimativa do seu Quociente de InteligÃªncia.</p>
    <div id="status" style="margin:.6rem 0;color:#a6b3cc">Carregando perguntasâ€¦</div>
    <div id="quiz"></div>
    <div style="margin-top:1rem"><button class="btn" id="enviar">Gerar resultado</button></div>
  </div>
</main>

<script src="/assets/supabase-init.js"></script>
<script>
window.addEventListener("braintest-ready", async () => {
  const session = (await sb.auth.getSession()).data.session;
  if(!session){ location.href="/"; return; }
  const { data:{ user } } = await sb.auth.getUser();
  const TEST = "qi";
  const status = document.getElementById("status");
  const quizEl = document.getElementById("quiz");
  let perguntas = [];

  try {
    const { data } = await sb.rpc("get_random_questions",{p_test_key:TEST,p_limit:15});
    if(data?.length) perguntas = data;
  } catch(e){console.warn("RPC falhou", e);}

  if(!perguntas.length){
    const { data } = await sb.from("test_questions")
      .select("id,prompt,kind,domain")
      .eq("test_key", TEST)
      .order("random()")
      .limit(15);
    perguntas = data || [];
  }

  if(!perguntas.length){ status.textContent="NÃ£o foi possÃ­vel carregar perguntas."; return; }
  status.textContent = `Foram carregadas ${perguntas.length} perguntas.`;

  const ids = perguntas.map(q=>q.id);
  const { data:opts } = await sb.from("test_question_options")
    .select("question_id,label,value,is_correct")
    .in("question_id", ids);
  const byQ = {};
  (opts||[]).forEach(o=>{(byQ[o.question_id] ||= []).push(o);});
  perguntas = perguntas.map(q=>({...q, options:byQ[q.id]||[]}));

  quizEl.innerHTML = perguntas.map((q,i)=>`
    <div class="question">
      <p><b>${i+1}.</b> ${q.prompt}</p>
      ${(q.options||[]).map(o=>`
        <label><input type="radio" name="q${q.id}" value="${o.is_correct?1:0}"> ${o.label}</label>
      `).join("")}
    </div>`).join("");

  document.getElementById("enviar").onclick = async() => {
    const respostas = perguntas.map(q=>{
      const v = document.querySelector(`input[name="q${q.id}"]:checked`);
      return {question_id:q.id,value:v?Number(v.value):0};
    });
    const corretas = respostas.filter(r=>r.value===1).length;
    const score = Math.round((corretas/perguntas.length)*100);
    await sb.from("test_sessions").insert({
      user_id:user.id,test_key:TEST,items_qty:respostas.length,score_qi:score
    });
    location.href="/qi-premium.html";
  };

  document.getElementById("searchBox").addEventListener("keypress",e=>{
    if(e.key==="Enter"){
      const t=e.target.value.toLowerCase();
      if(t.includes("tdah")) location.href="/teste-tdah.html";
      else if(t.includes("burn")) location.href="/teste-burnout.html";
    }
  });
});
</script>
</body>
</html>
