<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelatÃ³rio Premium - TDAH</title>
  <link rel="stylesheet" href="assets/ui.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabase-init.js"></script>
</head>
<body>
  <nav class="sidebar">
    <h2>ğŸ§  BrainTest</h2>
    <a href="index.html">ğŸ  InÃ­cio</a>
    <a href="testes.html">ğŸ§© Testes</a>
    <a href="carteira.html">ğŸ’° Carteira</a>
    <a href="perfil.html">ğŸ‘¤ Perfil</a>
    <a href="historico.html">ğŸ“œ HistÃ³rico</a>
    <a id="logout" class="logout-btn" onclick="logout()">ğŸšª Sair</a>
  </nav>

  <header>
    <div class="logo">RelatÃ³rio Premium - TDAH</div>
  </header>

  <main class="fade-in">
    <section class="card" id="reportCard">
      <h1>Carregando seu relatÃ³rio...</h1>
      <p>Estamos analisando suas respostas.</p>
    </section>
  </main>

  <script>
    async function salvarRelatorio(testKey, score, nivel, descricao, sugestoes) {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return;
      const userId = session.user.id;
      const { error } = await sb.from("test_reports").insert({
        user_id: userId,
        test_key: testKey,
        score: score,
        level: nivel,
        summary: descricao,
        recommendations: sugestoes
      });
      if (error) console.warn("Falha ao salvar relatÃ³rio:", error.message);
      else console.log("âœ… RelatÃ³rio salvo com sucesso!");
    }

    async function gerarRelatorio() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) return window.location.href = "login.html";
      const score = parseInt(sessionStorage.getItem("tdah_score") || "0");
      const report = document.getElementById("reportCard");
      report.innerHTML = "";

      let nivel = "", descricao = "", sugestoes = [];

      if (score < 10) {
        nivel = "Baixo";
        descricao = "Seu perfil indica boa capacidade de foco e organizaÃ§Ã£o. Pequenas distraÃ§Ãµes sÃ£o naturais no dia a dia.";
        sugestoes = [
          "Mantenha uma rotina previsÃ­vel e bem estruturada.",
          "Evite multitarefas desnecessÃ¡rias.",
          "Use listas e alarmes como suporte, sem rigidez excessiva."
        ];
      } else if (score < 20) {
        nivel = "Moderado";
        descricao = "Alguns sinais de dispersÃ£o surgem em contextos repetitivos ou estressantes.";
        sugestoes = [
          "TÃ©cnicas de mindfulness ajudam na regulaÃ§Ã£o da atenÃ§Ã£o.",
          "FaÃ§a pausas breves entre tarefas longas.",
          "Evite sobrecarga sensorial e notificaÃ§Ãµes excessivas."
        ];
      } else {
        nivel = "Elevado";
        descricao = "VocÃª demonstrou padrÃµes de impulsividade e desorganizaÃ§Ã£o que merecem atenÃ§Ã£o. Isso nÃ£o Ã© diagnÃ³stico, mas sugere procurar suporte especializado.";
        sugestoes = [
          "Busque avaliaÃ§Ã£o profissional para compreensÃ£o aprofundada.",
          "Adote ferramentas visuais de planejamento (kanban, apps).",
          "Priorize sono, alimentaÃ§Ã£o e pausas regulares."
        ];
      }

      report.innerHTML = `
        <h1>RelatÃ³rio Premium - TDAH</h1>
        <h3>NÃ­vel de atenÃ§Ã£o: <span style="color:#2563eb">${nivel}</span></h3>
        <p>${descricao}</p>
        <h4>RecomendaÃ§Ãµes</h4>
        <ul>${sugestoes.map(i => `<li>${i}</li>`).join('')}</ul>
        <p><em>Este relatÃ³rio Ã© apenas informativo e nÃ£o substitui avaliaÃ§Ã£o mÃ©dica.</em></p>
      `;

      await salvarRelatorio("tdah", score, nivel, descricao, sugestoes);
    }

    gerarRelatorio();
  </script>
</body>
</html>
