<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carteira | Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<style>
:root{--salmao:#ff8a73;--salmao-2:#ff7458;--azul:#1d3557;--bg:#f6f7fb;--card:#fff;--borda:#e9ecf2;--texto:#2b2b2b}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--texto)}
.wrap{max-width:1000px;margin:0 auto;padding:1rem}
header.top{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--borda);border-radius:14px;padding:1rem;margin-top:1rem}
.brand{display:flex;align-items:center;gap:.6rem}.brand img{width:28px}
.brand h1{font-family:'Poppins',sans-serif;font-size:1.2rem;color:var(--azul)}
nav a{margin-left:1rem;color:var(--azul);text-decoration:none}
.btn{background:var(--salmao);color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;font-weight:700;cursor:pointer}
.btn.secondary{background:#fff;color:var(--azul);border:1px solid var(--borda)}
.btn.small{padding:.35rem .6rem}
.btn:hover{background:var(--salmao-2)}
.badge{display:inline-block;border:1px solid var(--borda);border-radius:999px;padding:.2rem .6rem;background:#f7f9ff;font-size:.85rem;margin-left:.5rem}

.card{background:#fff;border:1px solid var(--borda);border-radius:14px;padding:1.2rem;margin-top:1rem}
h2{font-family:'Poppins',sans-serif;color:var(--azul);margin:.3rem 0 .6rem}
h3{color:#0e1d33;margin:.8rem 0 .4rem}
p{line-height:1.7;color:#303540}
.small{font-size:.92rem;color:#6b7380}
.hr{height:1px;background:var(--borda);margin:1rem 0}

.grid{display:grid;gap:1rem;grid-template-columns:repeat(3,1fr)}
@media(max-width:960px){.grid{grid-template-columns:1fr}}
.tile{border:1px solid var(--borda);border-radius:12px;background:#f9fbff;padding:1rem;display:flex;flex-direction:column;gap:.35rem}
.tile .price{font-size:1.3rem;font-weight:800;color:#0e1d33}
.tile .desc{font-size:.92rem;color:#6b7380}
.kpi{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
.kpi .val{font-size:1.5rem;font-weight:800;color:#0e1d33}
.note{background:#fff7f5;border:1px dashed #ffd5cb;border-radius:12px;padding:1rem}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.7rem;border-bottom:1px solid var(--borda);text-align:left}
.table th{font-weight:700;color:#0e1d33;background:#f9fbff}
.row-empty{padding:1rem;text-align:center;color:#6b7380}
.badge-kind{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.8rem}
.badge-credit{background:#f2fff5;border:1px solid #cdebd4;color:#184d2b}
.badge-debit{background:#fff7f5;border:1px solid #ffd5cb;color:#5f1f12}
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div class="brand"><img src="/assets/logo.svg" alt=""><h1>Braintest</h1></div>
    <nav>
      <a href="/index.html">Início</a>
      <a href="/historico.html">Histórico</a>
      <a href="/faq.html">FAQ</a>
      <a href="/sobre.html">Sobre</a>
      <span id="userInfo" class="badge">Carregando…</span>
      <button id="logoutBtn" class="btn secondary" style="display:none;margin-left:.5rem;">Sair</button>
    </nav>
  </header>

  <!-- Saldo -->
  <section class="card">
    <div class="kpi">
      <div>
        <div class="small">Seu saldo</div>
        <div class="val"><span id="saldoNow">0.00</span> Braincoins</div>
      </div>
      <button class="btn small" id="btnSync">Sincronizar saldo</button>
      <span class="small" id="syncMsg" style="margin-left:.4rem;color:#6b7380"></span>
    </div>
    <div class="note" style="margin-top:.8rem">
      <strong>Como funciona:</strong>
      <p class="small">Escolha um pacote abaixo para adicionar Braincoins. Após o pagamento no Stripe, volte para esta página e clique em <em>Sincronizar saldo</em> para atualizar. Se o crédito não aparecer em alguns minutos, fale com <a href="mailto:contato@braintest.com.br">contato@braintest.com.br</a>.</p>
    </div>
  </section>

  <!-- Pacotes -->
  <section class="card">
    <h2>Adicionar Braincoins</h2>
    <div class="grid" style="margin-top:.4rem">
      <div class="tile">
        <div class="price">10 BC</div>
        <div class="desc">R$ 10,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_fZu8wH67levadxH48L4Rq04')">Comprar 10 BC</button>
      </div>

      <div class="tile">
        <div class="price">30 BC</div>
        <div class="desc">R$ 30,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_28E3cn53h1Io79j0Wz4Rq05')">Comprar 30 BC</button>
      </div>

      <div class="tile">
        <div class="price">100 BC</div>
        <div class="desc">R$ 100,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_28EdR19jxaeUeBL9t54Rq07')">Comprar 100 BC</button>
      </div>

      <div class="tile">
        <div class="price">500 BC</div>
        <div class="desc">R$ 500,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_00wfZ9fHVcn28dnfRt4Rq08')">Comprar 500 BC</button>
      </div>

      <div class="tile">
        <div class="price">1000 BC</div>
        <div class="desc">R$ 1.000,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_9B6eV58ft2Ms1OZgVx4Rq09')">Comprar 1000 BC</button>
      </div>

      <div class="tile">
        <div class="price">3000 BC</div>
        <div class="desc">R$ 3.000,00</div>
        <button class="btn" onclick="openStripe('https://buy.stripe.com/test_bJedR1anBcn23X7fRt4Rq0a')">Comprar 3000 BC</button>
      </div>
    </div>
  </section>

  <!-- Extrato recente -->
  <section class="card">
    <h3>Extrato recente</h3>
    <table class="table" style="margin-top:.4rem">
      <thead>
        <tr><th>Tipo</th><th>Valor (BC)</th><th>Descrição</th><th>Data</th></tr>
      </thead>
      <tbody id="bodyExtrato">
        <tr><td colspan="4" class="row-empty">Carregando…</td></tr>
      </tbody>
    </table>
    <div class="hr"></div>
    <button class="btn secondary small" onclick="location.href='/historico.html'">Ver histórico completo</button>
  </section>
</div>

<script>
let userId = null;

function fmtBC(cents){ return (Math.abs(cents)/100).toFixed(2); }
function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString('pt-BR', {dateStyle:'short', timeStyle:'short'});
  }catch{ return iso || '-'; }
}

function openStripe(url){
  // abre o checkout em nova aba para o usuário poder voltar e sincronizar
  window.open(url, '_blank', 'noopener,noreferrer');
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await waitForSupabaseSession();
  const { data:{ user } } = await sb.auth.getUser();
  const ui = document.getElementById('userInfo');
  const logoutBtn = document.getElementById('logoutBtn');

  if(!user){
    ui.textContent = 'Visitante';
    alert('Faça login para acessar sua carteira.');
    location.href = '/index.html';
    return;
  }
  userId = user.id;
  ui.textContent = user.email || 'Usuário';
  logoutBtn.style.display = 'inline-block';

  await refreshSaldo();
  await loadExtrato();
});

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await sb.auth.signOut();
  location.href = '/index.html';
});

document.getElementById('btnSync').addEventListener('click', async ()=>{
  const msg = document.getElementById('syncMsg');
  msg.textContent = 'Sincronizando…';
  await refreshSaldo();
  await loadExtrato();
  msg.textContent = 'Atualizado.';
  setTimeout(()=> msg.textContent = '', 2000);
});

async function refreshSaldo(){
  const { data, error } = await sb.from('wallets').select('balance_cents').eq('user_id', userId).single();
  if(error){
    document.getElementById('saldoNow').textContent = '—';
    return;
  }
  document.getElementById('saldoNow').textContent = ((data?.balance_cents||0)/100).toFixed(2);
}

async function loadExtrato(){
  const tbody = document.getElementById('bodyExtrato');
  tbody.innerHTML = `<tr><td colspan="4" class="row-empty">Carregando…</td></tr>`;

  const { data, error } = await sb
    .from('wallet_transactions')
    .select('kind, amount_cents, description, created_at')
    .eq('user_id', userId)
    .order('created_at', { ascending:false })
    .limit(10);

  if(error){ tbody.innerHTML = `<tr><td colspan="4" class="row-empty">Erro ao carregar extrato.</td></tr>`; return; }

  if(!data || data.length===0){
    tbody.innerHTML = `<tr><td colspan="4" class="row-empty">Sem movimentações ainda.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(row=>{
    const badge = row.kind==='credit'
      ? `<span class="badge-kind badge-credit">Crédito</span>`
      : `<span class="badge-kind badge-debit">Débito</span>`;
    const val = (row.kind==='credit' ? '+' : '-') + fmtBC(row.amount_cents);
    return `<tr>
      <td>${badge}</td>
      <td>${val}</td>
      <td>${row.description||'-'}</td>
      <td>${fmtDate(row.created_at)}</td>
    </tr>`;
  }).join('');
}
</script>
</body>
</html>
