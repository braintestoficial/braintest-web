<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Triagem — TDAH | Braintest</title>
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<style>
.question {
  margin-bottom: 1rem;
  padding-bottom: .5rem;
  border-bottom: 1px solid var(--line);
}
.question p { margin: 0 0 .25rem; font-weight: 500; }
.question label { display: block; margin-left: 1rem; font-size: .95rem; color: #334; }
</style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <a class="brand" href="/index.html"><img src="/assets/logo.svg"><span>Braintest</span></a>
  </header>
  <main class="content">
    <div class="container">
      <div class="card">
        <h2>Triagem — TDAH</h2>
        <p class="small">Responda às <b>15</b> perguntas abaixo. As respostas geram um <b>resultado gratuito</b>; o relatório completo é premium e não substitui diagnóstico médico.</p>
        <div id="quiz">Carregando perguntas...</div>
        <button class="btn" id="enviar">Gerar resultado</button>
      </div>
    </div>
  </main>
</div>

<script>
const TEST='tdah';
const quizEl=document.getElementById('quiz');
let perguntas=[];

(async()=>{
  const { data:user }=await sb.auth.getUser();
  if(!user){window.location='/login.html';return;}

  const { data:qs, error } = await sb.from('test_questions')
    .select('id,prompt,kind,domain,test_question_options(label,value)')
    .eq('test',TEST)
    .order('random()')
    .limit(15);

  if(error){ quizEl.innerHTML='<p>Erro ao carregar perguntas.</p>'; console.error(error); return; }

  perguntas=qs;
  quizEl.innerHTML = qs.map((q,i)=>{
    const opts = q.test_question_options?.length
      ? q.test_question_options
      : [{label:'Raramente',value:0},{label:'Às vezes',value:1},{label:'Frequentemente',value:2}];
    return `
      <div class="question">
        <p><b>${i+1}.</b> ${q.prompt}</p>
        ${opts.map(o=>`
          <label><input type="radio" name="q${q.id}" value="${o.value}"> ${o.label}</label>
        `).join('')}
      </div>
    `;
  }).join('');
})();

document.getElementById('enviar').onclick = async()=>{
  const user=(await sb.auth.getUser()).data.user;
  if(!user)return;

  const respostas = perguntas.map(q=>{
    const val=document.querySelector(`input[name="q${q.id}"]:checked`);
    return {question_id:q.id,value:val?Number(val.value):null};
  });
  const items_qty=respostas.length;
  const score_likert = respostas.reduce((s,r)=>s+(r.value??0),0);
  const { data:sess } = await sb.from('test_sessions').insert({
    user_id:user.id,test:TEST,items_qty,score_likert
  }).select().single();
  for(const r of respostas){
    await sb.from('test_answers').insert({session_id:sess.id,question_id:r.question_id,value:r.value});
  }
  window.location='/tdah-premium.html';
};
</script>
</body>
</html>
