<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teste de TDAH | Braintest</title>
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
</head>
<body>
<header class="topbar">
  <a class="brand" href="/index.html"><img src="/assets/logo.svg" height="32"> Braintest</a>
  <div style="display:flex;align-items:center;gap:.5rem">
    <span id="userChip"></span> | ðŸ’° <span id="saldoTop">0</span> BC
  </div>
</header>

<main class="content">
  <div class="card">
    <h2>Triagem â€” TDAH</h2>
    <p>Responda 15 perguntas abaixo e receba uma estimativa inicial.</p>
    <div id="quiz">Carregando perguntas...</div>
    <button class="btn" id="enviar">Gerar resultado</button>
  </div>
</main>

<script>
(async()=>{
  const session=await waitForSupabaseSession();
  if(!session){location.href='/login.html';return;}
  const user=session.user;
  await ensureTopbarUser();

  const TEST='tdah';
  const quizEl=document.getElementById('quiz');
  let perguntas=[];

  try{
    const { data:qs,error }=await sb.from('test_questions')
      .select('id,prompt,kind,domain,test_question_options(label,value)')
      .eq('test_key',TEST).order('random()').limit(15);
    if(error||!qs)throw error;
    perguntas=qs;
  }catch(e){
    perguntas=Array.from({length:15},(_,i)=>({
      id:i+1,
      prompt:`Pergunta temporÃ¡ria ${i+1}`,
      test_question_options:[
        {label:'Raramente',value:0},
        {label:'Ã€s vezes',value:1},
        {label:'Frequentemente',value:2}
      ]
    }));
  }

  quizEl.innerHTML=perguntas.map((q,i)=>`
    <div class="question">
      <p><b>${i+1}.</b> ${q.prompt}</p>
      ${q.test_question_options.map(o=>`
        <label><input type="radio" name="q${q.id}" value="${o.value}"> ${o.label}</label>`).join('')}
    </div>`).join('');

  document.getElementById('enviar').onclick=async()=>{
    const respostas=perguntas.map(q=>{
      const v=document.querySelector(`input[name="q${q.id}"]:checked`);
      return{question_id:q.id,value:v?Number(v.value):null};
    });
    const soma=respostas.reduce((s,r)=>s+(r.value??0),0);
    await sb.from('test_sessions').insert({
      user_id:user.id,test_key:TEST,items_qty:respostas.length,score_likert:soma
    });
    location.href='/tdah-premium.html';
  };
})();
</script>
</body>
</html>
