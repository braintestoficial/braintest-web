<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Burnout — Triagem Aleatória | Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">

<!-- libs e supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>

<style>
:root{--salmao:#ff8a73;--salmao-2:#ff7458;--azul:#1d3557;--bg:#f6f7fb;--card:#fff;--borda:#e9ecf2;--texto:#2b2b2b}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--texto)}
.wrap{max-width:1000px;margin:0 auto;padding:1rem}
header.top{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--borda);border-radius:14px;padding:1rem;margin-top:1rem}
.brand{display:flex;align-items:center;gap:.6rem}.brand img{width:28px}
.brand h1{font-family:'Poppins',sans-serif;font-size:1.2rem;color:var(--azul)}
nav a{margin-left:1rem;color:var(--azul);text-decoration:none}
.btn{background:var(--salmao);color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;font-weight:700;cursor:pointer}
.btn.secondary{background:#fff;color:#0e1d33;border:1px solid var(--borda)}
.btn:hover{background:var(--salmao-2)}
.badge{display:inline-block;border:1px solid var(--borda);border-radius:999px;padding:.2rem .6rem;background:#f7f9ff;font-size:.85rem;margin-left:.5rem}
.badge.ok{background:#f2fff5;border-color:#cdebd4;color:#184d2b}
.card{background:#fff;border:1px solid var(--borda);border-radius:14px;padding:1.2rem;margin-top:1rem}
h2{font-family:'Poppins',sans-serif;color:var(--azul);margin:.3rem 0 .6rem}
.small{font-size:.92rem;color:#6b7380}
.hr{height:1px;background:var(--borda);margin:1rem 0}
.resultBox{padding:.9rem;border:1px solid var(--borda);border-radius:12px;background:#f9fbff}
.hide{display:none}
.q label{font-weight:600;display:block;margin-bottom:.3rem}
.q .opt{margin:.25rem 0}
</style>
</head>
<body>
<div class="wrap">
  <header class="top">
    <div class="brand"><img src="/assets/logo.svg" alt=""><h1>Braintest</h1></div>
    <nav>
      <a href="/index.html">Início</a>
      <a href="/carteira.html" class="btn secondary">Carteira: <span id="saldoTop">0.00</span> BC</a>
      <a href="/historico.html">Histórico</a>
      <a href="/perfil.html">Perfil</a>
      <span id="userInfo" class="badge">Carregando…</span>
      <button id="logoutBtn" class="btn secondary" style="display:none;margin-left:.5rem;">Sair</button>
    </nav>
  </header>

  <section class="card">
    <h2>Burnout — Triagem Aleatória (15 itens)</h2>
    <p class="small">Indicativa e não substitui avaliação clínica.</p>
    <div class="hr"></div>

    <div id="statusBox" class="small" style="margin-bottom:.6rem"></div>
    <form id="formBurnout"></form>
    <div id="resumo" class="resultBox" style="display:none;margin-top:1rem"></div>
  </section>

  <section class="card" id="buyBox">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
      <h3 style="margin:0">Relatório premium</h3>
      <span id="ownedBadge" class="badge ok hide">Desbloqueado</span>
    </div>
    <p class="small" id="premiumDesc">
      Interpretação por domínios + recomendações. Custo: <strong>10 Braincoins</strong>. Saldo: <strong id="saldoAqui">—</strong>
    </p>
    <div style="margin-top:.6rem">
      <button class="btn" id="btnBuy">Desbloquear relatório (10 BC)</button>
      <button class="btn secondary" id="btnAdd" onclick="location.href='/carteira.html'" style="margin-left:.5rem">Adicionar Braincoins</button>
      <button class="btn hide" id="btnOpen" onclick="location.href='/burnout-premium.html'">Abrir relatório</button>
    </div>
  </section>
</div>

<script>
const PRODUCT = 'burnout';
const PRICE_CENTS = 1000;
const PREMIUM_URL = '/burnout-premium.html';

function setStatus(msg, type='info'){
  const el = document.getElementById('statusBox');
  if(!el) return;
  el.innerHTML = `<div style="
    padding:.75rem;border:1px solid ${type==='error'?'#f5b5ab':'#e9ecf2'};
    background:${type==='error'?'#fff7f5':'#f9fbff'};border-radius:12px;
    color:#303540;font-size:.92rem">${msg}</div>`;
}

function renderForm(questions){
  const f = document.getElementById('formBurnout');
  f.innerHTML = '';
  questions.forEach((q, idx)=>{
    const block = document.createElement('div');
    block.className = 'q'; block.style.margin='.8rem 0';

    const label = document.createElement('label');
    label.style.fontWeight='600'; label.style.display='block'; label.style.marginBottom='.35rem';
    label.textContent = `${idx+1}. ${q.prompt}`;
    block.appendChild(label);

    (q.options||[]).forEach(opt=>{
      const wrap = document.createElement('div'); wrap.className='opt'; wrap.style.margin='.25rem 0';
      wrap.innerHTML = `
        <label>
          <input type="radio" name="q_${q.question_id}" required data-val="${opt.value ?? ''}">
          ${opt.label}
        </label>`;
      block.appendChild(wrap);
    });

    f.appendChild(block);
  });

  if(!f.querySelector('button[type=submit]')){
    const btn = document.createElement('button'); btn.type='submit'; btn.className='btn';
    btn.textContent='Ver resultado gratuito'; btn.style.marginTop='.8rem'; f.appendChild(btn);
  }

  f.onsubmit = (e)=>{
    e.preventDefault();
    let scoreLikert=0, countLikert=0;
    questions.forEach(q=>{
      const sel = f.querySelector(`input[name="q_${q.question_id}"]:checked`);
      if(sel){
        const v = sel.dataset.val === '' ? null : Number(sel.dataset.val);
        if(v!==null && !isNaN(v)){ scoreLikert += v; countLikert++; }
      }
    });
    const max = 2*countLikert;
    let nivel = 'baixo';
    if(scoreLikert >= Math.ceil(max*0.40)) nivel = 'moderado';
    if(scoreLikert >= Math.ceil(max*0.70)) nivel = 'elevado';
    const box = document.getElementById('resumo');
    box.innerHTML = `<strong>Resultado gratuito:</strong> Exaustão global: <b>${scoreLikert}/${max}</b> — indícios ${nivel}.<br><span class="small">Para ver a distribuição por domínios e recomendações, desbloqueie o premium.</span>`;
    box.style.display='block';
  };
}

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await waitForSupabaseSession();

    const { data:{ user } } = await sb.auth.getUser();
    const ui = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    if(!user){
      ui.textContent='Visitante'; logoutBtn.style.display='none';
      setStatus('Você precisa entrar para realizar esta triagem. <a href="/perfil.html">Entrar com Google</a>', 'error');
      document.getElementById('formBurnout').innerHTML = '<p class="small" style="color:#6b7380">Sem perguntas para exibir.</p>';
      return;
    }else{
      ui.textContent = user.email || 'Usuário';
      logoutBtn.style.display='inline-block';

      const { data:w } = await sb.from('wallets').select('balance_cents').eq('user_id', user.id).single();
      const bc = ((w?.balance_cents||0)/100).toFixed(2);
      document.getElementById('saldoTop').textContent = bc;
      document.getElementById('saldoAqui').textContent = `${bc} BC`;

      const { data: have } = await sb.from('purchases').select('product').eq('user_id', user.id).eq('product', PRODUCT).maybeSingle();
      if(have){
        document.getElementById('btnBuy').classList.add('hide');
        document.getElementById('btnAdd').classList.add('hide');
        document.getElementById('premiumDesc').textContent = 'Você já desbloqueou este relatório.';
        document.getElementById('btnOpen').classList.remove('hide');
        document.getElementById('ownedBadge').classList.remove('hide');
      }
    }

    setStatus('Carregando perguntas…');
    const { data, error } = await sb.rpc('get_random_questions', { p_test:'burnout', p_qty:15 });
    if(error){ setStatus('Erro ao carregar perguntas: <code>'+ (error.message||'desconhecido') +'</code>', 'error'); return; }
    if(!data || data.length===0){ setStatus('Não encontramos perguntas ativas para este teste.', 'error'); return; }

    setStatus(''); renderForm(data);
  }catch(e){
    setStatus('Falha inesperada ao carregar o teste. <code>'+ (e.message||e.toString()) +'</code>', 'error');
  }
});

document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{ await sb.auth.signOut(); location.href='/index.html'; });

document.getElementById('btnBuy').addEventListener('click', async ()=>{
  const { data:{ user } } = await sb.auth.getUser();
  if(!user){ alert('Faça login para continuar.'); location.href='/perfil.html'; return; }
  const { data:w } = await sb.from('wallets').select('balance_cents').eq('user_id', user.id).single();
  const balance = w?.balance_cents||0;
  if(balance < PRICE_CENTS){ if(confirm('Saldo insuficiente. Adicionar Braincoins agora?')) location.href='/carteira.html'; return; }
  const { error } = await sb.rpc('wallet_buy',{ p_product:PRODUCT, p_price_cents:PRICE_CENTS, p_description:'Relatório premium: BURNOUT' });
  if(error){ alert('Não foi possível concluir a compra.'); return; }
  location.href = PREMIUM_URL + '?ok=1';
});
</script>
</body>
</html>
