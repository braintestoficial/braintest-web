<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teste de Burnout | Braintest</title>
<link rel="stylesheet" href="/assets/ui.css">
<script async src="https://unpkg.com/@supabase/supabase-js@2"></script></head>
<body>
<header class="topbar">
  <a class="brand" href="/index.html"><img src="/assets/logo.svg" height="28"> Braintest</a>
  <div class="userbox"><b id="userChip"></b> â€” ğŸ’° <b id="saldoTop">0</b> BC</div>
</header>

<main class="content">
  <div class="card">
    <h2>Triagem â€” Burnout</h2>
    <p>Responda 15 perguntas. O relatÃ³rio premium traz insights e recomendaÃ§Ãµes personalizadas.</p>
    <div id="status" style="margin:.6rem 0;color:#a6b3cc">Carregando perguntasâ€¦</div>
    <div id="quiz"></div>
    <div style="margin-top:1rem"><button class="btn" id="enviar">Gerar resultado</button></div>
  </div>
</main>

<script src="/assets/supabase-init.js"></script>
<script>
window.addEventListener("braintest-ready", async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session){location.href="/";return;}
  const {data:{user}}=await sb.auth.getUser();
  document.getElementById("userChip").textContent=user.email.split("@")[0];
  const {data:wallet}=await sb.from("wallets").select("balance").eq("user_id",user.id).single();
  document.getElementById("saldoTop").textContent=wallet?.balance??0;

  const TEST="burnout";
  let perguntas=[];
  try{const {data}=await sb.rpc("get_random_questions",{p_test_key:TEST,p_limit:15});if(data?.length)perguntas=data;}catch{}
  if(!perguntas.length){
    const {data}=await sb.from("test_questions").select("id,prompt").eq("test_key",TEST).order("random()").limit(15);
    perguntas=data||[];
  }
  const {data:opts}=await sb.from("test_question_options").select("question_id,label,value").in("question_id",perguntas.map(q=>q.id));
  const byQ={};(opts||[]).forEach(o=>{(byQ[o.question_id] ||= []).push(o);});
  perguntas=perguntas.map(q=>({...q,options:byQ[q.id]||[]}));
  document.getElementById("quiz").innerHTML=perguntas.map((q,i)=>`
    <div class="question"><p><b>${i+1}.</b> ${q.prompt}</p>
    ${(q.options||[]).map(o=>`<label><input type="radio" name="q${q.id}" value="${o.value}"> ${o.label}</label>`).join("")}</div>`).join("");
  document.getElementById("enviar").onclick=async()=>{
    const respostas=perguntas.map(q=>{
      const v=document.querySelector(\`input[name="q\${q.id}"]:checked\`);
      return Number(v?.value||0);
    });
    const score=respostas.reduce((a,b)=>a+b,0);
    await sb.from("test_sessions").insert({user_id:user.id,test_key:TEST,items_qty:respostas.length,score_likert:score});
    location.href="/burnout-premium.html";
  };
});
</script></body></html>
