<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Triagem ‚Äî Burnout | Braintest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/ui.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/supabase-init.js"></script>
<script src="/assets/app.js" defer></script>
<style>
.form q{ display:block; margin:10px 0 8px; font-weight:600 }
.option{ display:flex; gap:10px; margin:4px 0; align-items:center }
.option input{ margin:0 }
.actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
@media(max-width:720px){ .actions .btn{ width:100% } }
</style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <a class="brand" href="/index.html"><img src="/assets/logo.svg" alt=""><span>Braintest</span></a>
    <div class="search"><input placeholder="Busque‚Ä¶"></div>
    <div class="top-actions">
      <div class="user-chip" id="userChip">Carregando‚Ä¶</div>
      <a class="btn alt" href="/carteira.html">Saldo: <span id="saldoTop">0.00</span> BC</a>
    </div>
  </header>

  <div class="body">
    <aside class="sidebar">
      <nav class="nav">
        <h6>Navega√ß√£o</h6>
        <a href="/index.html" data-current>üè† In√≠cio</a>
        <a href="/historico.html" data-current>üïò Hist√≥rico</a>
        <a href="/carteira.html" data-current>üí≥ Carteira</a>
        <a href="/perfil.html" data-current>üë§ Perfil</a>
        <h6 style="margin-top:14px">Testes</h6>
        <a href="/teste-tdah.html" data-current>‚ö° TDAH</a>
        <a href="/teste-burnout.html" class="active" data-current>üî• Burnout</a>
        <a href="/teste-qi.html" data-current>üß† QI</a>
      </nav>
    </aside>

    <main class="content">
      <div class="container">
        <div class="card">
          <h2 style="margin:0 0 8px;font-family:Poppins,Inter">Triagem ‚Äî Burnout</h2>
          <p class="small">Responda √†s **15** perguntas. Voc√™ ver√° um **resultado gratuito**; o relat√≥rio premium aprofunda Exaust√£o, Cinismo e Efic√°cia.</p>
          <div class="hr"></div>

          <form id="form" class="form"></form>

          <div class="actions">
            <button class="btn" id="btnEnviar" type="button">Gerar resultado</button>
            <button class="btn alt" id="btnLimpar" type="button">Limpar respostas</button>
          </div>

          <div id="resultado" style="display:none; margin-top:14px">
            <div class="hr"></div>
            <h3 style="margin:0 0 6px">Resultado (gratuito)</h3>
            <p class="small" id="resumo">‚Äî</p>
            <div class="actions">
              <button class="btn" id="btnPremium" type="button">Desbloquear relat√≥rio premium (10 BC)</button>
              <a class="btn alt" href="/burnout-premium.html">Abrir relat√≥rio (se j√° comprado)</a>
            </div>
          </div>

          <div id="status" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </main>
  </div>

  <nav class="mobilebar">
    <a href="/index.html" data-current>üè†</a>
    <a href="/teste-tdah.html" data-current>‚ö°</a>
    <a href="/teste-burnout.html" class="active" data-current>üî•</a>
    <a href="/teste-qi.html" data-current>üß†</a>
    <a href="/perfil.html" data-current>üë§</a>
  </nav>
</div>

<script>
const TEST='burnout', LIMIT=15, PRICE_CENTS=1000;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function setStatus(msg){ document.getElementById('status').innerHTML = msg||''; }

async function loadQuestions(){
  setStatus('Carregando perguntas‚Ä¶');
  const { data:qs, error } = await sb.from('test_questions')
    .select('id,prompt,kind,domain')
    .eq('test', TEST)
    .limit(60);
  if(error){ setStatus('<span style="color:#b00020">Erro ao carregar perguntas.</span>'); return []; }
  const chosen = shuffle([...(qs||[])]).slice(0, LIMIT);
  const qids = chosen.map(q=>q.id);
  const { data:opts } = await sb.from('test_question_options')
    .select('id,question_id,label,value,is_correct')
    .in('question_id', qids);
  const byQ = new Map(); (opts||[]).forEach(o=>{ if(!byQ.has(o.question_id)) byQ.set(o.question_id, []); byQ.get(o.question_id).push(o); });
  return chosen.map(q=>({ ...q, options: (byQ.get(q.id)||[]) }));
}

function renderForm(list){
  const form=document.getElementById('form'); form.innerHTML='';
  if(!list.length){ form.innerHTML='<p class="small">Nenhuma pergunta dispon√≠vel.</p>'; return; }
  list.forEach((q,idx)=>{
    const wrap=document.createElement('div'); wrap.className='q';
    const qid=`q_${q.id}`;
    wrap.innerHTML=`<q>${idx+1}. ${q.prompt}</q>`;
    (q.options||[]).forEach(opt=>{
      const rid = `${qid}_${opt.id}`;
      const row = document.createElement('label'); row.className='option';
      row.innerHTML = `<input type="radio" name="${qid}" value="${Number(opt.value)}" id="${rid}"> <span>${opt.label}</span>`;
      wrap.appendChild(row);
    });
    form.appendChild(wrap);
  });
}

async function submitForm(list, user){
  const answers=[]; let missing=0; let sum=0;
  list.forEach(q=>{
    const name=`q_${q.id}`;
    const sel=document.querySelector(`input[name="${name}"]:checked`);
    if(!sel){ missing++; return; }
    const v=Number(sel.value);
    sum += isNaN(v)?0:v;
    answers.push({ question_id:q.id, value:v, option_id: Number(sel.id.split('_').pop()) });
  });
  if(missing>0){ alert(`Responda todas as perguntas (${missing} em aberto).`); return; }

  setStatus('Salvando‚Ä¶');
  const { data:ins, error:errIns } = await sb.from('test_sessions').insert({
    user_id:user.id, test: TEST, items_qty: list.length, score_likert: sum
  }).select('id').single();
  if(errIns){ setStatus('<span style="color:#b00020">Falha ao salvar sess√£o.</span>'); return; }

  const rows = answers.map(a=>({ session_id:ins.id, question_id:a.question_id, option_id:a.option_id, value:a.value }));
  const { error:errAns } = await sb.from('test_answers').insert(rows);
  if(errAns){ setStatus('<span style="color:#b00020">Falha ao salvar respostas.</span>'); return; }

  const max = list.length*2;
  document.getElementById('resumo').innerHTML = `Pontua√ß√£o Likert: <b>${sum}</b> de ${max}.<br>
  <span class="small">Leitura r√°pida: exaust√£o e cinismo elevados em geral elevam a pontua√ß√£o, efic√°cia percebida menor tamb√©m pesa. Consulte o relat√≥rio premium para an√°lise por dom√≠nios.</span>`;
  document.getElementById('resultado').style.display='block';
  setStatus('Sess√£o salva com sucesso.');
}

async function buyPremium(user){
  setStatus('Processando compra‚Ä¶');
  const { error } = await sb.rpc('wallet_buy', { p_product: TEST, p_price_cents: PRICE_CENTS });
  if(error){ setStatus(`<span style="color:#b00020">N√£o foi poss√≠vel concluir a compra: ${error.message||''}</span>`); return; }
  location.href='/burnout-premium.html';
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const user = await requireAuth('/teste-burnout.html'); if(!user) return;
  await ensureTopbarUser();
  const list = await loadQuestions(); renderForm(list);

  document.getElementById('btnEnviar').addEventListener('click', ()=> submitForm(list, user));
  document.getElementById('btnLimpar').addEventListener('click', ()=>{ document.getElementById('form').reset?.(); document.getElementById('resultado').style.display='none'; setStatus(''); });
  document.getElementById('btnPremium').addEventListener('click', ()=> buyPremium(user));
});
</script>
</body>
</html>
